#include <video.h>
#include <_gr2D.h>
#include <_gr2Don.h>

#include <game.h>

#include <math.h>

#include <ftimage.h>
#include <ft2build.h>
#include <freetype.h>
//#define FT_FREETYPE_H
/*
#include <freetype2/freetype.h>
#include <fontconfig/fcfreetype.h>
*/

const char fonttable[256][8] = {
{  0,  0,  0,  0,  0,  0,  0,  0},{126,129,165,129,189,153,129,126},
{126,255,219,255,195,231,255,126},{108,254,254,254,124, 56, 16,  0},
{ 16, 56,124,254,124, 56, 16,  0},{ 56,124, 56,254,254,214, 16, 56},
{ 16, 56,124,254,254,124, 16, 56},{  0,  0, 24, 60, 60, 24,  0,  0},
{255,255,231,195,195,231,255,255},{  0, 60,102, 66, 66,102, 60,  0},
{255,195,153,189,189,153,195,255},{ 15,  7, 15,125,204,204,204,120},
{ 60,102,102,102, 60, 24,126, 24},{ 63, 51, 63, 48, 48,112,240,224},
{127, 99,127, 99, 99,103,230,192},{ 24,219, 60,231,231, 60,219, 24},
{128,224,248,254,248,224,128,  0},{  2, 14, 62,254, 62, 14,  2,  0},
{ 24, 60,126, 24, 24,126, 60, 24},{102,102,102,102,102,  0,102,  0},
{127,219,219,123, 27, 27, 27,  0},{ 62, 97, 60,102,102, 60,134,124},
{  0,  0,  0,  0,126,126,126,  0},{ 24, 60,126, 24,126, 60, 24,255},
{ 24, 60,126, 24, 24, 24, 24,  0},{ 24, 24, 24, 24,126, 60, 24,  0},
{  0, 24, 12,254, 12, 24,  0,  0},{  0, 48, 96,254, 96, 48,  0,  0},
{  0,  0,192,192,192,254,  0,  0},{  0, 36,102,255,102, 36,  0,  0},
{  0, 24, 60,126,255,255,  0,  0},{  0,255,255,126, 60, 24,  0,  0},
{  0,  0,  0,  0,  0,  0,  0,  0},{ 24, 60, 60, 24, 24,  0, 24,  0},
{102,102, 36,  0,  0,  0,  0,  0},{108,108,254,108,254,108,108,  0},
{ 24, 62, 96, 60,  6,124, 24,  0},{  0,198,204, 24, 48,102,198,  0},
{ 56,108, 56,118,220,204,118,  0},{ 24, 24, 48,  0,  0,  0,  0,  0},
{ 12, 24, 48, 48, 48, 24, 12,  0},{ 48, 24, 12, 12, 12, 24, 48,  0},
{  0,102, 60,255, 60,102,  0,  0},{  0, 24, 24,126, 24, 24,  0,  0},
{  0,  0,  0,  0,  0, 24, 24, 48},{  0,  0,  0,126,  0,  0,  0,  0},
{  0,  0,  0,  0,  0, 24, 24,  0},{  6, 12, 24, 48, 96,192,128,  0},
{124,198,206,214,230,198,124,  0},{ 24, 56, 24, 24, 24, 24,126,  0},
{124,198,  6, 28, 48,102,254,  0},{124,198,  6, 60,  6,198,124,  0},
{ 28, 60,108,204,254, 12, 30,  0},{254,192,192,252,  6,198,124,  0},
{ 56, 96,192,252,198,198,124,  0},{254,198, 12, 24, 48, 48, 48,  0},
{124,198,198,124,198,198,124,  0},{124,198,198,126,  6, 12,120,  0},
{  0, 24, 24,  0,  0, 24, 24,  0},{  0, 24, 24,  0,  0, 24, 24, 48},
{  6, 12, 24, 48, 24, 12,  6,  0},{  0,  0,126,  0,  0,126,  0,  0},
{ 96, 48, 24, 12, 24, 48, 96,  0},{124,198, 12, 24, 24,  0, 24,  0},
{124,198,222,222,222,192,120,  0},{ 56,108,198,254,198,198,198,  0},
{252,102,102,124,102,102,252,  0},{ 60,102,192,192,192,102, 60,  0},
{248,108,102,102,102,108,248,  0},{254, 98,104,120,104, 98,254,  0},
{254, 98,104,120,104, 96,240,  0},{ 60,102,192,192,206,102, 58,  0},
{198,198,198,254,198,198,198,  0},{ 60, 24, 24, 24, 24, 24, 60,  0},
{ 30, 12, 12, 12,204,204,120,  0},{230,102,108,120,108,102,230,  0},
{240, 96, 96, 96, 98,102,254,  0},{198,238,254,254,214,198,198,  0},
{198,230,246,222,206,198,198,  0},{124,198,198,198,198,198,124,  0},
{252,102,102,124, 96, 96,240,  0},{124,198,198,198,198,206,124, 14},
{252,102,102,124,108,102,230,  0},{124,198, 96, 56, 12,198,124,  0},
{126,126, 90, 24, 24, 24, 60,  0},{198,198,198,198,198,198,124,  0},
{198,198,198,198,198,108, 56,  0},{198,198,198,214,214,254,108,  0},
{198,198,108, 56,108,198,198,  0},{102,102,102, 60, 24, 24, 60,  0},
{254,198,140, 24, 50,102,254,  0},{ 60, 48, 48, 48, 48, 48, 60,  0},
{192, 96, 48, 24, 12,  6,  2,  0},{ 60, 12, 12, 12, 12, 12, 60,  0},
{ 16, 56,108,198,  0,  0,  0,  0},{  0,  0,  0,  0,  0,  0,  0,255},
{ 48, 24, 12,  0,  0,  0,  0,  0},{  0,  0,120, 12,124,204,118,  0},
{224, 96,124,102,102,102,220,  0},{  0,  0,124,198,192,198,124,  0},
{ 28, 12,124,204,204,204,118,  0},{  0,  0,124,198,254,192,124,  0},
{ 60,102, 96,248, 96, 96,240,  0},{  0,  0,118,204,204,124, 12,248},
{224, 96,108,118,102,102,230,  0},{ 24,  0, 56, 24, 24, 24, 60,  0},
{  6,  0,  6,  6,  6,102,102, 60},{224, 96,102,108,120,108,230,  0},
{ 56, 24, 24, 24, 24, 24, 60,  0},{  0,  0,236,254,214,214,214,  0},
{  0,  0,220,102,102,102,102,  0},{  0,  0,124,198,198,198,124,  0},
{  0,  0,220,102,102,124, 96,240},{  0,  0,118,204,204,124, 12, 30},
{  0,  0,220,118, 96, 96,240,  0},{  0,  0,126,192,124,  6,252,  0},
{ 48, 48,252, 48, 48, 54, 28,  0},{  0,  0,204,204,204,204,118,  0},
{  0,  0,198,198,198,108, 56,  0},{  0,  0,198,214,214,254,108,  0},
{  0,  0,198,108, 56,108,198,  0},{  0,  0,198,198,198,126,  6,252},
{  0,  0,126, 76, 24, 50,126,  0},{ 14, 24, 24,112, 24, 24, 14,  0},
{ 24, 24, 24, 24, 24, 24, 24,  0},{112, 24, 24, 14, 24, 24,112,  0},
{118,220,  0,  0,  0,  0,  0,  0},{  0, 16, 56,108,198,198,254,  0},
{ 62,102,198,198,254,198,198,  0},{254,102, 96,124,102,102,252,  0},
{252,102,102,124,102,102,252,  0},{254,102, 96, 96, 96, 96,240,  0},
{ 30, 54,102,102,102,102,255,195},{254, 98,104,120,104, 98,254,  0},
{214,214,124, 56,124,214,214,  0},{124,198,  6, 60,  6,198,124,  0},
{198,198,206,222,246,230,198,  0},{ 56,198,206,222,246,230,198,  0},
{230,102,108,120,108,102,230,  0},{ 30, 54,102,102,102,102,198,  0},
{198,238,254,254,214,198,198,  0},{198,198,198,254,198,198,198,  0},
{124,198,198,198,198,198,124,  0},{254,198,198,198,198,198,198,  0},
{252,102,102,102,124, 96,240,  0},{124,198,192,192,192,198,124,  0},
{126, 90, 24, 24, 24, 24, 60,  0},{198,198,198,126,  6,198,124,  0},
{124,214,214,214,124, 16, 56,  0},{198,198,108, 56,108,198,198,  0},
{204,204,204,204,204,204,254,  6},{198,198,198,126,  6,  6,  6,  0},
{214,214,214,214,214,214,254,  0},{214,214,214,214,214,214,255,  3},
{240,240,176, 60, 54, 54, 60,  0},{198,198,198,246,222,222,246,  0},
{240, 96, 96,124,102,102,124,  0},{120,140,  6, 62,  6,140,120,  0},
{220,214,214,246,214,214,220,  0},{126,198,198,198,126,102,198,  0},
{  0,  0,120, 12,124,204,118,  0},{  6,124,192,124,198,198,124,  0},
{  0,  0,252,102,124,102,252,  0},{  0,  0,254,102, 96, 96,240,  0},
{  0,  0, 60,108,108,108,254,198},{  0,  0,124,198,254,192,124,  0},
{  0,  0,214,124, 56,124,214,  0},{  0,  0,124,198, 28,198,124,  0},
{  0,  0,198,206,222,246,230,  0},{  0, 56,198,206,222,246,230,  0},
{  0,  0,230,108,120,108,230,  0},{  0,  0, 62,102,102,102,230,  0},
{  0,  0,198,254,254,214,198,  0},{  0,  0,198,198,254,198,198,  0},
{  0,  0,124,198,198,198,124,  0},{  0,  0,254,198,198,198,198,  0},
{ 17, 68, 17, 68, 17, 68, 17, 68},{ 85,170, 85,170, 85,170, 85,170},
{221,119,221,119,221,119,221,119},{ 24, 24, 24, 24, 24, 24, 24, 24},
{ 24, 24, 24,248, 24, 24, 24, 24},{ 24,248, 24,248, 24, 24, 24, 24},
{ 54, 54, 54,246, 54, 54, 54, 54},{  0,  0,  0,254, 54, 54, 54, 54},
{  0,248, 24,248, 24, 24, 24, 24},{ 54,246,  6,246, 54, 54, 54, 54},
{ 54, 54, 54, 54, 54, 54, 54, 54},{  0,254,  6,246, 54, 54, 54, 54},
{ 54,246,  6,254,  0,  0,  0,  0},{ 54, 54, 54,254,  0,  0,  0,  0},
{ 24,248, 24,248,  0,  0,  0,  0},{  0,  0,  0,248, 24, 24, 24, 24},
{ 24, 24, 24, 31,  0,  0,  0,  0},{ 24, 24, 24,255,  0,  0,  0,  0},
{  0,  0,  0,255, 24, 24, 24, 24},{ 24, 24, 24, 31, 24, 24, 24, 24},
{  0,  0,  0,255,  0,  0,  0,  0},{ 24, 24, 24,255, 24, 24, 24, 24},
{ 24, 31, 24, 31, 24, 24, 24, 24},{ 54, 54, 54, 55, 54, 54, 54, 54},
{ 54, 55, 48, 63,  0,  0,  0,  0},{  0, 63, 48, 55, 54, 54, 54, 54},
{ 54,247,  0,255,  0,  0,  0,  0},{  0,255,  0,247, 54, 54, 54, 54},
{ 54, 55, 48, 55, 54, 54, 54, 54},{  0,255,  0,255,  0,  0,  0,  0},
{ 54,247,  0,247, 54, 54, 54, 54},{ 24,255,  0,255,  0,  0,  0,  0},
{ 54, 54, 54,255,  0,  0,  0,  0},{  0,255,  0,255, 24, 24, 24, 24},
{  0,  0,  0,255, 54, 54, 54, 54},{ 54, 54, 54, 63,  0,  0,  0,  0},
{ 24, 31, 24, 31,  0,  0,  0,  0},{  0, 31, 24, 31, 24, 24, 24, 24},
{  0,  0,  0, 63, 54, 54, 54, 54},{ 54, 54, 54,255, 54, 54, 54, 54},
{ 24,255, 24,255, 24, 24, 24, 24},{ 24, 24, 24,248,  0,  0,  0,  0},
{  0,  0,  0, 31, 24, 24, 24, 24},{255,255,255,255,255,255,255,255},
{  0,  0,  0,255,255,255,255,255},{240,240,240,240,240,240,240,240},
{ 15, 15, 15, 15, 15, 15, 15, 15},{255,255,255,  0,  0,  0,  0,  0},
{  0,  0,252,102,102,124, 96,240},{  0,  0,124,198,192,198,124,  0},
{  0,  0,126, 90, 24, 24, 60,  0},{  0,  0,198,198,198,126,  6,124},
{  0,  0,124,214,214,124, 16, 56},{  0,  0,198,108, 56,108,198,  0},
{  0,  0,204,204,204,204,254,  6},{  0,  0,198,198,126,  6,  6,  0},
{  0,  0,214,214,214,214,254,  0},{  0,  0,214,214,214,214,255,  3},
{  0,  0,240,176, 60, 54, 60,  0},{  0,  0,198,198,246,222,246,  0},
{  0,  0,240, 96,124,102,252,  0},{  0,  0,124,198, 30,198,124,  0},
{  0,  0,220,214,246,214,220,  0},{  0,  0,126,198,126,102,198,  0},
{108,254, 98,120, 96, 98,254,  0},{108,  0,124,198,254,192,124,  0},
{ 60,102,192,248,192,102, 60,  0},{  0,  0, 62, 99,120, 99, 62,  0},
{ 72,120, 48, 48, 48, 48,120,  0},{204,  0, 48, 48, 48, 48,120,  0},
{ 56,198,198,126,  6,198,124,  0},{108, 56,198,198,198,126,  6,124},
{ 56,108,108, 56,  0,  0,  0,  0},{  0,  0,  0, 24, 24,  0,  0,  0},
{  0,  0,  0,  0, 24,  0,  0,  0},{ 14, 12, 12, 12,108, 60, 28,  0},
{143,205,239,252,220,204,204,  0},{  0,198,124,198,198,124,198,  0},
{  0,  0, 60, 60, 60, 60,  0,  0},{  0,  0,  0,  0,  0,  0,  0,  0}
};

FT_Library ft;
FT_Face face;


typedef struct {
	// ID handle of the glyph texture
	GLuint textureId;
	// Size of glyph
	int size_x;
	int size_y;
	// Offset from baseline to left/top of glyph
	int bearing_x;
	int bearing_y;
	// Offset to advance to next glyph
	GLuint advance;
}character_t;

character_t characters[128];

void fonts_init()
{

	if(FT_Init_FreeType(&ft))
		game_halt("Could not init freetype library");


#define FONTPATH "/usr/share/fonts/gnu-free/"

	//if(FT_New_Face(ft, FONTPATH"FreeSerif.ttf", 0, &face)) {
	if(FT_New_Face(ft, FONTPATH"FreeSansBold.ttf", 0, &face)) {
		game_halt("Could not open font");
	}

	FT_Set_Pixel_Sizes(face, 0, 48);

#define CHAR_AMOUNT (128)
	GLuint textures[CHAR_AMOUNT];
	glGenTextures(CHAR_AMOUNT, textures);


	for (GLubyte c = 0; c < CHAR_AMOUNT; c++)
	{

		// Load character glyph
		if (FT_Load_Char(face, c, FT_LOAD_RENDER))
		{
			game_halt("ERROR::FREETYTPE: Failed to load Glyph");
			continue;
		}

		int sx = face->glyph->bitmap.width;
		int sy = face->glyph->bitmap.rows;
		int size = sx * sy;
#define PLANES (4)
		uint8_t * buf = malloc(size * PLANES);

#define TRANSPARENT_COLOR_INDEX (0)

		int i = 0;
		int iindex = 0;
		float intencity = 1;
		for(i = 0; i < size; i++)
		{
			int pindex = face->glyph->bitmap.buffer[i];
			int color = pindex * intencity;
			buf[iindex++] = color;
			buf[iindex++] = color;
			buf[iindex++] = color;
			buf[iindex++] = (pindex == TRANSPARENT_COLOR_INDEX) ? 255 : OPAQUE;
		}

		glBindTexture(GL_TEXTURE_2D, textures[c]);
		glTexImage2D(
			GL_TEXTURE_2D,
			0,
			GL_RGBA,
			sx,
			sy,
			0,
			GL_RGBA,
			GL_UNSIGNED_BYTE,
			buf
		);

		free(buf);

		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);

		character_t character = {
				.textureId = textures[c],
				.size_x    = sx,
				.size_y    = sy,
				.bearing_x = face->glyph->bitmap_left,
				.bearing_y = face->glyph->bitmap_top,
				.advance = face->glyph->advance.x >> 6
		};
		characters[c] = character;

	}


}

void fonts_done()
{
FT_Done_Face(face);
FT_Done_FreeType(ft);
}
/*
 * рисование указанного символа
 */
int gr2Don_setchar(
	int x,
	int y,
	char ch
)
{

	int www = characters['A'].size_x;
	int hhh = characters['A'].size_y;

	GLfloat scalex = VIDEO_MODE_W / 320.0f;
	GLfloat scaley = VIDEO_MODE_H / 200.0f;


	float cscalex = (8.0f / www) * scalex;
	float cscaley = (8.0f / hhh) * scaley;


	character_t * character = &characters[ch%128];

	// Size of glyph
	//GLfloat mdl_sx = character->size_width;
	//GLfloat mdl_sy = character->size_rows;
	// Offset from baseline to left/top of glyph
	//GLint texture_x1 = character->bearing_bitmap_left;
	//GLint texture_y1 = character->bearing_bitmap_top;

	GLint texture_x1 = 1.0f;
	GLint texture_y1 = 1.0f;

	// Offset to advance to next glyph

	GLfloat xpos = x + character->bearing_x * cscalex;

	//GLfloat ypos = y - (character->size_y - character->bearing_y) * scale;

	//GLfloat ypos = y - character->bearing_y * scale; // GOOD!!!

	//GLfloat ypos = y - character->bearing_y * scale + hhh * scale;

	GLfloat ypos = y - ( character->bearing_y - hhh) * cscalex;

	//GLfloat ypos = y - character->bearing_y * scale;

	//GLfloat ypos = y - 16 - (character->size_y) * scale;

	GLfloat w = character->size_x * cscalex;
	GLfloat h = character->size_y * cscaley;


	glBindTexture(GL_TEXTURE_2D, character->textureId);
	glLoadIdentity();
	glTranslatef(xpos, ypos, 0.0f);
	glBegin(GL_QUADS);
	float grayColor = 0.35f;
	glColor3f(grayColor, grayColor, grayColor);
	glTexCoord2f(texture_x1, texture_y1); glVertex2f(w, h); // Верхний правый угол квадрата
	glTexCoord2f(texture_x1, 0.0f      ); glVertex2f(w, 0.0f  ); // Нижний правый
	glTexCoord2f(0.0f      , 0.0f      ); glVertex2f(0.0f  , 0.0f  ); // Нижний левый
	glTexCoord2f(0.0f      , texture_y1); glVertex2f(0.0f  , h); // Верхний левый
	glEnd();	// Закончили квадраты
	//return character->advance;
	return (int) ( (float) character->advance * cscalex);
}


/*
 * вывод текста на экран
 */
void gr2Don_settext(
	int x,
	int y,
	enum text_orient_e orientation,
	const char * format,
	...
	)
{

	static char string[MAX_MESSAGE_SIZE];
	va_list argptr;
	va_start(argptr, format);
#ifdef HAVE_VSNPRINTF
	vsnprintf(string, MAX_MESSAGE_SIZE, format, argptr);
#else
	vsprintf(string, format, argptr);
#endif
	va_end(argptr);

	int i = 0;
	int adv;

	while(string[i])
	{
		adv = gr2Don_setchar(x, y, string[i]);
		x += adv;
		i++;
	}
}
